# Quantum Tunneling (Tunneling)

## 1. ツール紹介

**Quantum Tunneling (Tunneling)** は、効率的で安定したイントラネットポート貫通ツールで、リバーストンネル技術を使用しています。単一の公開サーバーを通じて、複数のイントラネットサービス（リモートデスクトップ、Web、SSH、メディアサーバーなど）への安全な外部アクセスを実現します。

### アーキテクチャ説明 (C/S モード)

Tunneling はクラシックな **Client/Server (C/S) アーキテクチャ** を採用しており、**リバーストンネル** モードとも呼ばれ、イントラネット貫通シナリオに非常に適しています。

#### サーバー

- **公開IP** を有するサーバー（VPS、クラウドサーバー、または家庭ブロードバンド公開ホスト）に展開。
- 外部リクエストの监听とすべてのポートマッピングルール（`MapProxy`）の集中管理を担当。
- イントラネットクライアントからのアクティブ接続を受け入れ、持続的なトンネルチャネルを確立。
- 外部からの `PublicPort` へのアクセスを対応するクライアントのイントラネットサービスに転送。

#### クライアント

- イントラネット内の**任意**のホスト（NAS、パソコン、開発機、Raspberry Pi など）に展開。
- **各クライアントは一意の AccessToken を通じて一組のマッピングルール（`MapGroup`）に対応**し、異なるイントラネット環境（例: 家庭、オフィス）の隔離管理を実現。
- 単一のクライアントでそのグループ内で設定されたすべてのイントラネットサービスを貫通可能（複数ホストとポートをサポート）。
- 複数の独立したイントラネット環境を貫通する場合、各環境で異なる `AccessToken` を使用して別々のクライアントインスタンスを実行するだけ。
- クライアントはイントラネットルーターのポート開放を必要とせず、サーバーに対してアクティブに長寿命接続（ハートビートキープアライブ付き）を開始・維持。

#### 典型的な展開例（イントラネットに Tunneling.Client を1つだけ展開すればよい）

- 公開サーバー（IP: 8.134.13.229）で `Tunneling.Server` を実行
- イントラネットホスト A（192.168.1.100）で `Tunneling.Client` を実行 → RDP と Web サービスを公開
- イントラネットホスト B（192.168.1.200）で Jellyfin と SSH を公開する場合、`Tunneling.Client` を実行する必要なし
- **すべてのマッピングルールはサーバーの `appsettings.json` で統一的に設定**

#### 利点まとめ

- 複数のイントラネット環境、複数ホスト、複数サービスの同時貫通をサポートし、グループ隔離管理。
- イントラネットホストに公開IPやポート開放不要。
- クライアント設定が極めてシンプル：サーバーアドレスと対応する AccessToken を入力するだけ。
- 高セキュリティ（AccessToken 認証 + HTTPS 推奨）。

**コア原理**：

- イントラネットクライアントが特定の `AccessToken` を使用して公開サーバーに対して長寿命接続をアクティブに確立。
- サーバーが事前にポートマッピングルール（`MapProxy`）を定義。
- クライアント接続成功後、サーバーは公開ポートへの外部アクセスをリアルタイムで対応クライアントのイントラネットサービスに転送。
- 複数のイントラネットマシンの同時接続をサポート（イントラネットごとに1つのクライアントインスタンスを実行）。

**利点**：

- 設定が極めてシンプルで高セキュリティ（`AccessToken` 認証サポート）。
- 家庭NAS、自ホストサービス公開、リモートワーク、開発デバッグなどのシナリオに適する。

**注意事項**：

- サーバーは公開IPを有し、ファイアウォール/セキュリティグループで必要なポートを許可する必要がある。
- すべてのトラフィックはサーバーを経由するため、サーバーの信頼性とセキュリティを確保。

## 2. システム要件

- **サーバーとクライアント**：Windows / Linux / macOS をサポート。
- プログラムファイル：
  - サーバー：`Tunneling.Server`（または `Tunneling.Server.exe`）
  - クライアント：`Tunneling.Client`（または `Tunneling.Client.exe`）

## 3. ファイル構成

リリースパッケージには以下が含まれます：

- `Tunneling.Server.exe` (Windows) または `Tunneling.Server` (Linux/macOS) — サーバー単一ファイル実行可能ファイル
- `Tunneling.Client.exe` (Windows) または `Tunneling.Client` (Linux/macOS) — クライアント単一ファイル実行可能ファイル
- `appsettings.json` (サーバーとクライアントの設定テンプレート)
- `README.md` (本マニュアル)

## 4. サーバー展開と設定

### 4.1 展開手順

1. サーバー実行ファイルと `appsettings.json` を同じディレクトリに置く。
2. `appsettings.json` を編集（以下参照）。
3. ファイアウォール/セキュリティグループで `urls` とすべての `MapProxy.PublicPort` で指定されたポートを許可。
4. 実行ファイルを直接実行。

### 4.2 サーバー設定ファイル (appsettings.json)

```json
{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning"
    }
  },
  "AllowedHosts": "*",
  "urls": "http://*:1984",
  "SystemConfig": {
    "UserName": "admin",
    "Password": "123123",
    "MapGroups": [
      {
        "GroupName": "家庭 NAS",
        "AccessToken": "A982D360-E59E-4012-B4AF-E571169218AA",
        "MapProxy": [
          {
            "Name": "win2016 リモートデスクトップ",
            "PublicPort": 2000,
            "LocalHost": "192.168.1.234",
            "LocalPort": 3389
          },
          {
            "Name": "Jellyfin",
            "PublicPort": 8096,
            "LocalHost": "192.168.1.250",
            "LocalPort": 8096
          },
          {
            "Name": "SSH",
            "PublicPort": 10022,
            "LocalHost": "192.168.1.234",
            "LocalPort": 22
          },
          {
            "Name": "MyWeb",
            "PublicPort": 8080,
            "LocalHost": "192.168.1.234",
            "LocalPort": 80
          }
        ]
      },
      {
        "GroupName": "オフィスネットワーク",
        "AccessToken": "C795479D-800E-49D9-BC38-A0B91B8A5544",
        "MapProxy": [
          {
            "Name": "win2022 リモートデスクトップ",
            "PublicPort": 4000,
            "LocalHost": "192.168.1.248",
            "LocalPort": 3389
          },
          {
            "Name": "SQL Server",
            "PublicPort": 21433,
            "LocalHost": "127.0.0.1",
            "LocalPort": 1433
          },
          {
            "Name": "Redis",
            "PublicPort": 26379,
            "LocalHost": "127.0.0.1",
            "LocalPort": 6379
          },
          {
            "Name": "Elasticsearch",
            "PublicPort": 29200,
            "LocalHost": "127.0.0.1",
            "LocalPort": 9200
          },
          {
            "Name": "Coremail",
            "PublicPort": 29000,
            "LocalHost": "127.0.0.1",
            "LocalPort": 9000
          },
          {
            "Name": "ESXi システム",
            "PublicPort": 28081,
            "LocalHost": "127.0.0.1",
            "LocalPort": 8081
          },
          {
            "Name": "MySQL",
            "PublicPort": 23306,
            "LocalHost": "127.0.0.1",
            "LocalPort": 3306
          }
        ]
      }
    ]
  }
}
```

### 4.3 MapProxy 設定項目表説明

`MapGroups` はマッピンググループの配列で、任意の数のグループを追加して異なるイントラネット環境の隔離を実現できます。

| フィールド名    | 説明                                             | 例値                           | 必須    | 注意事項                                   |
|-----------------|--------------------------------------------------|--------------------------------|---------|--------------------------------------------|
| GroupName      | 管理とログ識別のためのグループ名                  | 家庭 NAS                      | はい    | 意味のある名前を推奨；一意であること       |
| AccessToken    | このグループのクライアント認証トークン            | A982D360-...                   | はい    | 一意でクライアントと完全に一致する必要     |
| MapProxy       | このグループのポートマッピングルールの配列        | ...                            | はい    | 複数のマッピングルールを追加可能           |

`MapProxy` はポートマッピングルールの配列で、任意の数を追加可能。各エントリは公開する1つのイントラネットサービスに対応。

| フィールド名   | 説明                                                                     | 例値          | 必須    | 注意事項                                                           |
|----------------|--------------------------------------------------------------------------|---------------|---------|--------------------------------------------------------------------|
| Name           | マッピング名、ログとルール識別にのみ使用、可読性のため                   | リモートデスクトップ | はい    | 一意であること；意味のある名前を推奨                               |
| PublicPort     | 外部アクセスポート（公開ユーザーが実際に接続するポート）                  | 2000          | はい    | 一意であること；サーバー `urls` ポートと競合不可                   |
| LocalHost      | イントラネットターゲットホストIP（クライアントチャネル経由転送；サーバーは直接アクセス不要） | 192.168.1.234 | はい    | `127.0.0.1` または任意のLANデバイスIPをサポート                   |
| LocalPort      | イントラネットターゲットサービスポート                                    | 3389          | はい    | サービスの実際の监听ポートに対応（例: RDP 3389）                   |

**マッピング効果例**（サーバー公開IPが8.134.13.229の場合）：

| マッピング名     | 外部アクセスアドレス    | 実際転送イントラネットサービス |
|------------------|-------------------------|--------------------------------|
| リモートデスクトップ | 8.134.13.229:2000       | 192.168.1.234:3389             |
| Jellyfin         | 8.134.13.229:8096       | 192.168.1.250:8096             |
| SSH              | 8.134.13.229:10022      | 192.168.1.239:22               |
| MyWeb            | 8.134.13.229:8080       | 192.168.1.248:80               |

## 5. クライアント展開と設定 (Tunneling.Client)

### 5.1 設定ファイル (appsettings.json)

クライアント実行ファイルと同じディレクトリに置く：

```json
{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft": "Warning"
    }
  },
  "Server": {
    "ServerAddress": "http://8.134.13.229:1984/",
    "AccessToken": "A982D360-E59E-4012-B4AF-E571169218AA"
  }
}
```

**フィールド説明**：

- `ServerAddress`：完全なサーバーアドレス、`http://` または `https://` で始め、`/` で終わる。
- `AccessToken`：**サーバーと完全に一致**する必要。

### 5.2 Windows 実行方法

**1. コンソールモード（デバッグに適する）**

```cmd
Tunneling.Client.exe
```

**2. クライアントをWindowsサービスとしてインストール（推奨、起動時自動開始）**

- 管理者権限でコマンドプロンプトまたはPowerShellを開き、実行：

- **サービスインストール**：

```cmd
sc create TunnelingClient binPath= "C:\path\to\Tunneling.Client.exe --service" start= auto
```

- **サービス開始**：

```cmd
sc start TunnelingClient
```

- **サービス停止**：

```cmd
sc stop TunnelingClient
```

- **サービスアンインストール**：

```cmd
sc delete TunnelingClient
```

- **状態確認**：

```cmd
sc query TunnelingClient
```

### 5.3 Linux / macOS 実行方法

```bash
chmod +x Tunneling.Client
./Tunneling.Client
```

`systemd` または `nohup` を使用して起動時自動開始を推奨。

## 6. 使用方法

外部ネットワークからサーバー公開IP + PublicPort を直接使用して対応イントラネットサービスにアクセス（4.3の表の例を参照）。

## 7. セキュリティ注意事項（必読）

初回展開時は必ず変更：

- サーバーの `UserName` と `Password` → 強力なパスワード
- 各 `MapGroups` の `AccessToken` → 複雑なランダムGUID、各グループで異なる
- すべてのクライアントの `AccessToken` を対応グループと一致させる

すべてのトラフィックはサーバーを経由するため、サーバーセキュリティを確保。

## 8. 一般的なトラブルシューティング

- クライアント接続不可：`ServerAddress`、ポート許可、`AccessToken` の一致を確認
- 外部アクセス失敗：サーバーログでクライアントがオンラインかを確認
- Windowsサービス問題：イベントビューアーを確認

ご利用をお楽しみください！ 🚀